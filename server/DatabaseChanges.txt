-- 2011-04-03 New Column Story.DetectedAt

ALTER TABLE Story ADD COLUMN DetectedAt DATETIME;
UPDATE Story SET DetectedAt=CreatedAt;


-- 2011-04-03 New Column Comment.DetectedAt

ALTER TABLE Comment ADD COLUMN DetectedAt DATETIME;
UPDATE Comment SET DetectedAt=CreatedAt;

-- 2011-07-24 New SP [RecentlyCommentedStories]


-- 2011-07-30 New SP [RecentActivity]



-- 2011-10-30 New Column Story.TotalUpdates, Story.TotalChecks



-- 2011-11-06

ALTER TABLE Story DROP COLUMN ModificationAge
ALTER TABLE Story ADD LastModifiedAt DATETIME NOT NULL DEFAULT GETDATE()
ALTER TABLE Story ADD LastCommentedAt DATETIME NULL



-- 2011-11-07

CREATE      FUNCTION [dbo].[parseURL]  (@strURL varchar(1000))
RETURNS varchar(1000)
AS
BEGIN
IF CHARINDEX('http://',@strURL) > 0 OR CHARINDEX('https://',@strURL) > 0
-- Ghetto-tastic
SELECT @strURL = REPLACE(@strURL,'https://','')
SELECT @strURL = REPLACE(@strURL,'http://','')
--SELECT @strURL = REPLACE(@strURL,'www','')
-- Remove everything after "/" if one exists
IF CHARINDEX('/',@strURL) > 0 (SELECT @strURL = LEFT(@strURL,CHARINDEX('/',@strURL)-1))

-- Optional: Remove subdomains but differentiate between www.google.com and www.google.com.au
/*IF (LEN(@strURL)-LEN(REPLACE(@strURL,'.','')))/LEN('.') < 3 -- if there are less than 3 periods
SELECT @strURL = PARSENAME(@strURL,2) + '.' + PARSENAME(@strURL,1)
ELSE -- It's likely a google.co.uk, or google.com.au
SELECT @strURL = PARSENAME(@strURL,3) + '.' + PARSENAME(@strURL,2) + '.' + PARSENAME(@strURL,1)*/
RETURN @strURL
END

ALTER TABLE Story ADD Host nvarchar(100) NULL

UPDATE Story SET Host = dbo.ParseUrl(Url)

ALTER TABLE Story ADD ModificationAge bigint not null default(0)

ALTER TABLE Story ADD VoteCount int not null default(0)

UPDATE Story SET VoteCount=(
	SELECT COUNT(*) FROM StoryVote WHERE StoryVote.Story_id = Story.Id GROUP BY Story_id
)


-- 2012-01-21

-- Some indices for the SqlCe version:

CREATE INDEX IX_Story_CreatedAt ON Story (CreatedAt DESC);
CREATE INDEX IX_Story_LastCommentedAt ON Story (LastCommentedAt DESC);
CREATE INDEX IX_Story_LastModifiedAt ON Story (LastModifiedAt DESC);
CREATE INDEX IX_Story_ModificationAge ON Story (ModificationAge ASC);

CREATE INDEX IX_StoryVote_CreatedAt ON StoryVote (CreatedAt DESC);

CREATE INDEX IX_Comment_CreatedAt ON Comment (CreatedAt DESC);

CREATE INDEX IX_CommentVote_CreatedAt ON CommentVote (CreatedAt DESC);

-- 2012-01-29

-- new column Story.RemovedAt

ALTER TABLE Story ADD RemovedAt DATETIME NULL
